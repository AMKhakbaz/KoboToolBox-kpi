# Generated by Django 3.2.15 on 2023-01-12 14:27

from django.conf import settings
import django.contrib.postgres.indexes
import django.db.models.expressions
from django.db import migrations


def manually_create_index_instructions(apps, schema_editor):
    print(
        """
        !!! ATTENTION !!!
        If you have existing projects you need to run the SQL query below in PostgreSQL directly:

           > CREATE INDEX CONCURRENTLY settings__country_codes_idx on kpi_asset USING GIN((settings->'country_codes'));

        Otherwise, project views will perform very poorly.
        """
    )


def manually_drop_index_instructions(apps, schema_editor):
    print(
        """
        !!! ATTENTION !!!
        Run the SQL query below in PostgreSQL directly:
        
           > DROP INDEX IF EXISTS settings__country_codes_idx;
        """
    )


class Migration(migrations.Migration):

    dependencies = [
        ('kpi', '0045_project_view_export_task'),
    ]

    if not settings.SKIP_HEAVY_MIGRATIONS:
        operations = [
            migrations.AddIndex(
                model_name='asset',
                index=django.contrib.postgres.indexes.GinIndex(django.db.models.expressions.F('settings__country_codes'), name='settings__country_codes_idx'),
            ),
        ]
    else:
        operations = [
            migrations.RunPython(
                manually_create_index_instructions,
                manually_drop_index_instructions,
            )
        ]
