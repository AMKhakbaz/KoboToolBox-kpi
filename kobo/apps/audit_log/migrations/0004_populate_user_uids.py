# Generated by Django 3.2.15 on 2023-03-28 16:23

from django.core.paginator import Paginator
from django.db import migrations, models

from kpi.fields.kpi_uid import UUID_LENGTH


def update_user_uids(apps, schema_editor):

    AuditLog = apps.get_model('audit_log', 'AuditLog')  # noqa
    page_size = 10000
    paginator = Paginator(
        AuditLog.objects.filter(user_uid='')
        .select_related('user', 'user__extra_details')
        .order_by('pk'),
        page_size,
    )
    for page in paginator.page_range:
        audit_logs = paginator.page(page).object_list
        for audit_log in audit_logs:
            if audit_log.user:
                audit_log.user_uid = audit_log.user.extra_details.uid
        AuditLog.objects.bulk_update(audit_logs, ['user_uid'], batch_size=2000)


def noop(*args, **kwargs):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('hub', '0009_add_uid_to_extra_details'),
        ('audit_log', '0003_alter_auditlog_user'),
    ]

    operations = [
        migrations.AddField(
            model_name='auditlog',
            name='user_uid',
            field=models.CharField(
                default='',
                max_length=UUID_LENGTH + 1,
            ),
        ),
        migrations.RunPython(update_user_uids, noop),
    ]
