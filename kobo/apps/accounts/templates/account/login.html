{% extends "account/base.html" %}
{% load static %}
{% load i18n %}
{% load account socialaccount %}
{% block content %}


  <form method="post" action="{% url 'account_login' %}" class="registration registration--login">
    {#  KoboToolbox Logo #}
    <div class="registration--logo"><a href="/">
    {% block logo %}{{ block.super }}{% endblock %}
    </a></div>

    {# SSO Providers, Username, and Password #}
    {% get_providers as socialaccount_providers %}
    {% if socialaccount_providers %}
      <div class="socialaccount_ballot">
        <ul class="socialaccount_providers">
          {% include "socialaccount/snippets/provider_list.html" with process="login" %}
        </ul>
      </div>
      {% include "socialaccount/snippets/login_extra.html" %}
    {% endif %}


    {% csrf_token %}
    {{ form.as_p }}
    {% if redirect_field_value %}
      <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
    {% endif %}

    {# Login Button #}
    <button
      type="submit"
      name="Login"
      class="kobo-button kobo-button--blue kobo-button--fullwidth"
    >
      {% trans "Login" %}
    </button>

    {# Create an account, Forgot Password? #}
    <div class="registration__create-or-forgot">
      {% if config.REGISTRATION_OPEN %}
        <a href="{{ signup_url }}" class="registration__create-account">
          {% trans "Create an account" %}
        </a>
      {% endif %}

      <a href="{% url 'account_reset_password' %}" class="registration__forgot-password">
        {% trans "Forgot password?" %}
      </a>
    </div>

    {# SSO section #}
    <div class="registration__sso registration__sso--hidden registration__sso--login">
      <hr></hr>
      <h2>{% trans "Log in using SSO" %}</h2>
      <p>
        {% trans "If you set up Single Sign On in your account settings, you will only be able to log in through this method." %}
        {# TODO: Link to documentation #}
        {# <a href="#">{% trans "Learn more" %}</a> #}
      </p>
      <div class="registration__sso-buttons">
        {# JS relocates the providers list here. #}
      </div>
    </div>

    <script>
      jQuery(function () {
        // {# TODO: Implement these changes using Django template logic instead of CSS/JS, here and in signup.html #}

        // {# HACK: Setup SSO section with JS - see also signup.html #}
        var providers = document.querySelectorAll('a.socialaccount_provider')
        if (providers.length > 0 ) {
          // Move list
          var providersList = document.querySelector('ul.socialaccount_providers')
          document.querySelector('.registration__sso-buttons').append(providersList)

          // Modify SSO login link appearances:
          document.querySelectorAll('a.socialaccount_provider').forEach((el) => {
            // Style as button
            el.classList.add('kobo-button', 'kobo-button--sso', 'kobo-button--fullwidth')

            if (providers.length === 1) {
              // Label with "SSO Login"
              el.innerText = '{% trans "SSO Login" %}'
            } else {
              // Label with provider name
              el.innerText = '{% trans "Log in with" %} ' + el.title
            }
          })

          // Unhide the SSO section
          document.querySelector('.registration__sso').classList.remove('registration__sso--hidden')
        }

        // {# Polish: Make SSO links act more like buttons #}
        document.addEventListener('keydown', function(e) {
          if ((e.code === 'Space') && e.target.classList.contains('kobo-button--sso')) {
            e.target.click()
          }
        })
      })
    </script>

  </form>
{% endblock %}
