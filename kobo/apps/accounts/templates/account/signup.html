{% extends "account/base.html" %} {% load static %}
{% load i18n %}
{% load account socialaccount %}

{% block content %}
<form action="{% url 'set_language' %}" method="post" class="language-switcher">
  {% csrf_token %}
    <input name="next" type="hidden" value="{{ redirect_to }}" />
    <select name="language" onchange="this.form.submit()">
        {% get_current_language as LANGUAGE_CODE %}
        {% get_available_languages as LANGUAGES %}
        {% get_language_info_list for LANGUAGES as languages %}
        {% for language in languages %}
            <option value="{{ language.code }}"{% if language.code == LANGUAGE_CODE %} selected="selected"{% endif %}>
                {{ language.name_local }}
            </option>
        {% endfor %}
    </select>
    <input type="submit" value="Go" class="hidden" />
</form>

<form action="." method="post" class="registration registration--register">
  <div class="registration--logo">
    <a href="/">
      {% block logo %}{{ block.super }}{% endblock %}
    </a>
  </div>
  <div class="registration__first-half">
    <h1>{% trans "Create an account" %}</h1>
      {% csrf_token %}
      {% for field in form %}
          <div class="field {{ field.name }}">
            {{ field.label_tag|cut:':' }}
            {% if field.field.required %}
              <span class="required">*</span>
            {% endif %}

            {{ field }}
            {% if field.help_text %}
              <p class="help">{{ field.help_text|safe }}</p>
            {% endif %}
            {{ field.errors }}
          </div>

          {% if field.name == 'password1' %}
            <div class="field" id="registration-password-app"></div>
          {% endif %}
      {% endfor %}

      <button
        type="submit"
        name="Create Account"
        class="kobo-button kobo-button--blue kobo-button--fullwidth"
      >
        {% trans "Create Account" %}
      </button>

      <div class="registration__orlogin">
        {% trans "or" %} <a href="{{ login_url }}">{% trans "login" %}</a>
      </div>
  </div>

  <div class="registration__second-half">
      {# SSO section #}
      <div class="registration__sso registration__sso--hidden registration__sso--signup">
        <h2>{% trans "Register using SSO" %}</h2>
        <p>
          {% trans "If you set up Single Sign On in your account settings, you will only be able to log in through this method." %}
          {# TODO: Link to documentation #}
          {# <a href="#">{% trans "Learn more" %}</a> #}
        </p>
        <div class="registration__sso-buttons">
          {% get_providers as socialaccount_providers %}
          {% if socialaccount_providers %}
            <ul class="socialaccount_providers">
              {% include "socialaccount/snippets/provider_list.html" with process="login" %}
            </ul>
            {% include "socialaccount/snippets/login_extra.html" %}
          {% endif %}
        </div>
      </div>
      <script>
        jQuery(function () {
          // {# TODO: Consolidate these modifications with Django template logic rather than JS #}
          // {# HACK: Setup SSO section with JS - see also login.html #}
          var providers = document.querySelectorAll('a.socialaccount_provider')
          if (providers.length > 0 ) {
            // Modify SSO login link appearances:
            document.querySelectorAll('a.socialaccount_provider').forEach((el) => {
              // Style as button
              el.classList.add('kobo-button', 'kobo-button--sso', 'kobo-button--fullwidth')

              if (providers.length === 1) {
                // Label with "Register with SSO"
                el.innerText = '{% trans "Register with SSO" %}'
              } else {
                // Label with provider name
                el.innerText = '{% trans "Register with" %} ' + el.title
              }
            })

            // Unhide the SSO section
            document.querySelector('.registration__sso').classList.remove('registration__sso--hidden')
          }

          // {# Polish: Make SSO buttons act like real buttons #}
          document.addEventListener('keydown', function(e) {
            if ((e.code === 'Space') && e.target.classList.contains('kobo-button--sso')) {
              e.target.click()
            }
          })
        })
      </script>

      {% if welcome_message %} {{ welcome_message|safe }} {% else %}
      <p>KoboToolbox is an integrated set of tools for building forms and collecting interview responses. It is built by the Harvard Humanitarian Initiative for easy and reliable use in difficult field settings, such as humanitarian emergencies or
          post-conflict environments. <a href="http://www.kobotoolbox.org">Read more</a></p>
      {% endif %}
  </div>
  <div style="clear:both;"></div>
</form>
{% endblock %}
