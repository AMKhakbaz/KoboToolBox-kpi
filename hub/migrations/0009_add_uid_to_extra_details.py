# Generated by Django 3.2.15 on 2023-03-28 14:54

from django.core.paginator import Paginator
from django.db import migrations, models

from kpi.fields.kpi_uid import KpiUidField, UUID_LENGTH


def add_uid_to_extra_details(apps, schema_editor):
    ExtraUserDetail = apps.get_model('hub', 'ExtraUserDetail')  # noqa
    page_size = 10000
    paginator = Paginator(
        ExtraUserDetail.objects.all().order_by('pk'), page_size
    )
    for page in paginator.page_range:
        user_details = paginator.page(page).object_list
        for user_detail in user_details:
            if not user_detail.uid:
                user_detail.uid = KpiUidField.generate_unique_id('u')
        ExtraUserDetail.objects.bulk_update(user_details, ['uid'])


def noop(*args, **kwargs):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('hub', '0008_add_removal_dates_to_extrauserdetail'),
    ]

    operations = [
        migrations.AddField(
            model_name='extrauserdetail',
            name='uid',
            field=models.CharField(
                default='',
                max_length=UUID_LENGTH + 1,
            ),
        ),
        migrations.RunPython(add_uid_to_extra_details, noop),
        migrations.AlterField(
            model_name='extrauserdetail',
            name='uid',
            field=KpiUidField(uid_prefix='u'),
        )
    ]
